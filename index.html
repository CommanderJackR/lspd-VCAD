<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSPD CAD System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif; background-image: url('https://i.ibb.co/F1f3Dq7/LSPD-2.png');
            background-size: cover; background-position: center; background-attachment: fixed;
            overflow: hidden; user-select: none; background-color: #000; height: 100vh; margin: 0;
        }
        #bootScreenOverlay, #macOSLoginScreen, #shutdownScreenOverlay, #powerButtonScreenEl { /* Added powerButtonScreenEl */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        #bootScreenOverlay { background-color: #000; z-index: 10000; }
        #bootScreenOverlay .apple-logo-boot { font-size: 80px; margin-bottom: 40px; }
        .progress-bar-container { width: 200px; height: 5px; background-color: #333; border-radius: 3px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: #fff; border-radius: 3px; transition: width 0.1s linear; }

        #powerButtonScreenEl { background-color: #000; z-index: 10001; /* Highest when PC is off */ }
        #powerButtonIcon {
            font-size: 70px;
            color: #555; /* Dimmed power button */
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
        }
        #powerButtonIcon:hover {
            color: #fff; /* Brighter on hover */
            transform: scale(1.1);
        }


        #macOSLoginScreen { z-index: 9999; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background-color: rgba(0,0,0,0.3); }
        .macos-login-box { text-align: center; padding: 40px; }
        .macos-login-box .user-avatar { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 20px auto; object-fit: cover; border: 3px solid rgba(255,255,255,0.5); }
        .macos-login-box .user-name { font-size: 20px; font-weight: 500; color: white; margin-bottom: 20px; }
        .macos-login-box input[type="password"] { padding: 10px 15px; border: 1px solid rgba(255,255,255,0.3); background-color: rgba(255,255,255,0.1); border-radius: 20px; width: 250px; font-size: 14px; color: white; text-align: center; margin-bottom: 15px; outline: none; }
        .macos-login-box input[type="password"]::placeholder { color: rgba(255,255,255,0.6); }
        .macos-login-box button.login-button-macos { padding: 8px 18px; background-color: rgba(255,255,255,0.2); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
        .macos-login-box button.login-button-macos:hover { background-color: rgba(255,255,255,0.4); }
        .macos-login-error { color: #ff8a80; font-size: 13px; margin-top: 10px; height: 20px; }
        #shutdownScreenOverlay { background-color: #000; z-index: 9998; font-size: 20px; }
        #shutdownScreenOverlay .fa-power-off { font-size: 50px; margin-bottom: 20px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .macos-menu-bar { background-color: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); color: #333; padding: 0 15px; height: 28px; display: flex; align-items: center; font-size: 13px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 1px 0 rgba(0,0,0,0.1); }
        .macos-menu-bar .apple-logo-menu { font-size: 16px; margin-right: 15px; cursor: pointer; position: relative; }
        .apple-menu-dropdown { position: absolute; top: 25px; left: 0; background-color: rgba(240, 240, 240, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.15); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 5px 0; z-index: 1001; min-width: 200px; font-size: 13px; }
        .apple-menu-dropdown-item { padding: 6px 20px; cursor: pointer; color: #333; }
        .apple-menu-dropdown-item:hover { background-color: #007aff; color: white; }
        .apple-menu-separator { height: 1px; background-color: rgba(0,0,0,0.1); margin: 5px 0; }
        .macos-menu-bar .menu-item { padding: 0 8px; cursor: default; }
        .macos-menu-bar .menu-item.font-bold { font-weight: 600; }
        .macos-menu-bar .right-menu { margin-left: auto; display: flex; align-items: center; }
        .macos-menu-bar .right-menu .icon { margin-left: 15px; font-size: 14px; }
        .macos-dock { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background-color: rgba(255, 255, 255, 0.4); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 18px; padding: 8px; display: flex; gap: 10px; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; }
        .macos-dock-item { width: 50px; height: 50px; background-color: rgba(240, 240, 240, 0.7); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #333; cursor: pointer; transition: transform 0.1s ease-out, margin-bottom 0.1s ease-out; position: relative; }
        .macos-dock-item:hover { transform: scale(1.3) translateY(-10px); margin-bottom: 5px; background-color: rgba(250, 250, 250, 0.9); }
        .macos-dock-item .tooltip { position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
        .macos-dock-item:hover .tooltip { opacity: 1; visibility: visible; }
        .cad-window { position: absolute; top: 50px; left: 50px; width: 80vw; max-width: 1200px; height: 80vh; max-height: 900px; background-color: #f0f0f0; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; resize: both; min-width: 700px; min-height: 500px; z-index: 900; visibility: hidden; transition: width 0.2s ease-out, height 0.2s ease-out, top 0.2s ease-out, left 0.2s ease-out, border-radius 0.2s ease-out; }
        .cad-window.visible { visibility: visible; }
        .cad-window.maximized { border-radius: 0 !important; resize: none !important; }
        .window-header { background-color: #e0e0e0; padding: 0 12px; height: 32px; display: flex; align-items: center; cursor: grab; border-top-left-radius: inherit; border-top-right-radius: inherit; border-bottom: 1px solid #c5c5c5; }
        .window-header:active { cursor: grabbing; }
        .window-controls { display: flex; gap: 8px; }
        .window-control { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; }
        .control-close { background-color: #ff5f57; border: 1px solid #e0443e;}
        .control-minimize { background-color: #ffbd2e; border: 1px solid #dea123;}
        .control-maximize { background-color: #28c940; border: 1px solid #1DAD2B;}
        .window-title { flex-grow: 1; text-align: center; font-size: 13px; font-weight: 500; color: #555; pointer-events: none; }
        .window-body { flex-grow: 1; overflow: hidden; background-color: #ffffff; display: flex; }
        .cad-program { width: 100%; height: 100%; flex-direction: row; display: flex; }
        .cad-sidebar { width: 230px; background-color: #e9ecef; padding: 15px; border-right: 1px solid #ced4da; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .cad-sidebar-header { text-align: center; margin-bottom: 15px; }
        .cad-sidebar-header .officer-id { font-weight: 600; font-size: 14px; color: #333; }
        .cad-sidebar-item { padding: 10px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; color: #343a40; transition: background-color 0.2s, color 0.2s; display: flex; align-items: center; gap: 10px; }
        .cad-sidebar-item i.fa-fw { width: 1.5em; }
        .cad-sidebar-item:hover, .cad-sidebar-item.active { background-color: #007aff; color: white; }
        .cad-main-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .cad-main-content h3 { font-size: 20px; font-weight: 600; color: #333; margin-bottom: 15px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; }
        .copnet-section .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
        .copnet-section .search-bar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
        .copnet-section input[type="text"], .copnet-section input[type="date"], .copnet-section input[type="time"], .copnet-section select, .copnet-section textarea { padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; flex-grow: 1; }
        .copnet-section textarea { min-height: 80px; }
        .copnet-section button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
        .copnet-section button:hover { background-color: #0056b3; }
        .copnet-section button.secondary { background-color: #6c757d; }
        .copnet-section button.secondary:hover { background-color: #545b62; }
        .copnet-section button.danger { background-color: #dc3545; }
        .copnet-section button.danger:hover { background-color: #bd2130; }
        .results-area { margin-top: 20px; }
        .results-area table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .results-area th, .results-area td { border: 1px solid #dee2e6; padding: 8px 10px; text-align: left; vertical-align: middle;}
        .results-area th { background-color: #f8f9fa; }
        .results-area .action-buttons button { margin-right: 5px; padding: 4px 8px; font-size: 12px; }
        .detail-view { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;}
        .detail-view h4 { font-size: 16px; margin-bottom: 10px; color: #007bff; border-bottom: 1px solid #e0e0e0; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center;}
        .detail-view p { margin-bottom: 8px; font-size: 14px; line-height: 1.6; }
        .detail-view strong { color: #495057; min-width: 120px; display: inline-block;}
        .detail-view .flag { padding: 3px 8px; border-radius: 4px; font-size: 12px; color: white; margin-left: 5px;}
        .flag.wanted { background-color: #dc3545; }
        .flag.caution { background-color: #ffc107; color: #333; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .detail-view img.profile-pic, .detail-view img.vehicle-pic { max-width: 150px; height: auto; border-radius: 6px; margin-bottom: 10px; border: 1px solid #ddd; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .dashboard-card { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; }
        .dashboard-card h4 { font-size: 16px; font-weight: 500; margin-bottom: 10px; color: #007aff; }
        .dashboard-card ul { list-style: disc; padding-left: 20px; font-size: 14px; color: #555;}
        .dashboard-card li { margin-bottom: 5px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .modal-box { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h4 { font-size: 18px; font-weight: 600; color: #333; }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #777; }
        .modal-body form label { display: block; margin-bottom: 5px; font-size: 14px; color: #555; font-weight: 500;}
        .modal-body form input, .modal-body form textarea, .modal-body form select { width: 100%; margin-bottom: 15px; }
        .modal-footer { margin-top: 20px; text-align: right; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-available { background-color: #28a745; }
        .status-busy { background-color: #ffc107; }
        .status-unavailable { background-color: #dc3545; }
        .status-offduty { background-color: #6c757d; }
        .resizer { width: 10px; height: 10px; background: transparent; position:absolute; right:0; bottom:0; cursor:nwse-resize; }
        .hidden { display: none !important; }
        .flex-display { display: flex !important; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="powerButtonScreenEl" class="flex-display"> <i id="powerButtonIcon" class="fas fa-power-off"></i>
    </div>

    <div id="bootScreenOverlay" class="hidden"><i class="fab fa-apple apple-logo-boot"></i><div class="progress-bar-container"><div id="bootProgressBar" class="progress-bar"></div></div></div>
    <div id="macOSLoginScreen" class="hidden"><div class="macos-login-box"><img src="https://i.ibb.co/5gR8SmSv/lspd-logo.png" alt="LSPD Officer" class="user-avatar" onerror="this.src='https://placehold.co/100x100/cccccc/ffffff?text=PD';"><div id="macOSLoginUserName" class="user-name">PD-61</div><input type="password" id="macOSPasswordInput" placeholder="Passwort eingeben"><button id="macOSLoginButton" class="login-button-macos"><i class="fas fa-arrow-right"></i></button><p id="macOSLoginError" class="macos-login-error"></p></div></div>
    <div id="shutdownScreenOverlay" class="hidden"><i class="fas fa-power-off"></i><span>Herunterfahren...</span></div>

    <div id="desktopEnvironment" class="hidden">
        <div class="macos-menu-bar">
            <div id="appleLogoMenuContainer" class="apple-logo-menu"><i class="fab fa-apple"></i><div id="appleMenuDropdownEl" class="apple-menu-dropdown hidden"><div class="apple-menu-dropdown-item">Über diesen Mac (simuliert)</div><div class="apple-menu-separator"></div><div id="logoutMacOSMenuItem" class="apple-menu-dropdown-item">Abmelden (PD-61)...</div><div class="apple-menu-separator"></div><div id="shutdownMenuItem" class="apple-menu-dropdown-item">Herunterfahren...</div></div></div>
            <span class="menu-item font-bold">LSPD CAD</span><span class="menu-item">Ablage</span><span class="menu-item">Bearbeiten</span><span class="menu-item">Darstellung</span><span class="menu-item">Fenster</span><span class="menu-item">Hilfe</span>
            <div class="right-menu"><span id="currentTimeEl" class="menu-item text-xs"></span><i class="fas fa-wifi icon"></i><i class="fas fa-battery-full icon"></i><i class="fas fa-search icon"></i></div>
        </div>

        <div id="cadWindowEl" class="cad-window">
            <div class="window-header" id="windowHeaderEl">
                <div class="window-controls"><div class="window-control control-close" id="closeButtonEl"></div><div class="window-control control-minimize" id="minimizeButtonEl"></div><div class="window-control control-maximize" id="maximizeButtonEl"></div></div>
                <div class="window-title">LSPD CAD System</div>
            </div>
            <div class="window-body">
                <div id="cadProgramEl" class="cad-program">
                    <div class="cad-sidebar">
                        <div class="cad-sidebar-header"><img src="https://i.ibb.co/5gR8SmSv/lspd-logo.png" alt="LSPD Logo" class="h-12 mx-auto mb-2" onerror="this.src='https://placehold.co/48x48/cccccc/333333?text=LSPD';"><div id="officerIdDisplayInCADEl" class="officer-id">PD-XXXX</div></div>
                        <div class="cad-sidebar-item active" data-target="dashboardContent"><i class="fas fa-tachometer-alt fa-fw"></i> Dashboard</div>
                        <div class="cad-sidebar-item" data-target="personSearchContent"><i class="fas fa-user-friends fa-fw"></i> Personensuche</div>
                        <div class="cad-sidebar-item" data-target="vehicleSearchContent"><i class="fas fa-car fa-fw"></i> Fahrzeugsuche</div>
                        <div class="cad-sidebar-item" data-target="dispatchContent"><i class="fas fa-headset fa-fw"></i> Leitstelle</div>
                        <div class="cad-sidebar-item" data-target="boloContent"><i class="fas fa-bullseye fa-fw"></i> Fahndungen</div>
                        <div class="cad-sidebar-item" data-target="reportsContent"><i class="fas fa-file-alt fa-fw"></i> Berichte</div>
                        <div class="cad-sidebar-item" data-target="knowledgeBaseContent"><i class="fas fa-book fa-fw"></i> Gesetze & DB</div>
                    </div>
                    <div class="cad-main-content">
                        <div id="dashboardContent" class="active-content copnet-section"><h3>Willkommen im LSPD CAD, Officer <span id="loggedInOfficerNameEl"></span></h3><div class="dashboard-grid"><div class="dashboard-card"><h4><i class="fas fa-bell"></i> Aktive Einsätze</h4><ul id="dashboardActiveIncidentsList"><li>Keine aktiven Einsätze</li></ul></div><div class="dashboard-card"><h4><i class="fas fa-clipboard-list"></i> Meine letzten Berichte</h4><ul id="dashboardMyReportsList"><li>Keine Berichte</li></ul></div><div class="dashboard-card"><h4><i class="fas fa-users"></i> Team Status</h4><ul id="unitStatusListDashboardEl"><li>Keine Einheiten im Dienst</li></ul></div><div class="dashboard-card"><h4><i class="fas fa-exclamation-triangle"></i> Wichtige Fahndungen</h4><ul><li>John Doe (Bankraub)</li></ul></div></div></div>

                        <div id="personSearchContent" class="hidden copnet-section">
                            <div class="section-header"><h3>Personensuche</h3><button id="createNewPersonBtnEl"><i class="fas fa-user-plus"></i> Neue Akte erstellen</button></div>
                            <div class="search-bar"><input type="text" id="personSearchNameInputEl" placeholder="Name, Vorname..."><input type="text" id="personSearchIdInputEl" placeholder="Bürger-ID..."><button id="personSearchBtnEl"><i class="fas fa-search"></i> Suchen</button></div>
                            <div id="personResultsAreaEl" class="results-area"><p class="text-gray-500">Bitte Suchkriterien eingeben.</p></div>
                            <div id="personDetailViewEl" class="detail-view hidden">
                                <div class="flex items-start gap-4">
                                    <img id="detailPersonProfilePicEl" src="https://placehold.co/100x100/cccccc/ffffff?text=Bild" alt="Profilbild" class="profile-pic" onerror="this.src='https://placehold.co/100x100/cccccc/ffffff?text=Bild';">
                                    <div><h4><span id="detailViewPersonNameEl"></span> <span id="detailViewPersonWantedFlagEl" class="flag hidden"></span></h4><p><strong>Bürger-ID:</strong> <span id="detailPersonIdEl"></span></p><p><strong>Geburtsdatum:</strong> <span id="detailPersonDobEl"></span></p></div>
                                    <button id="editPersonBtnEl" class="ml-auto secondary"><i class="fas fa-edit"></i> Bearbeiten</button>
                                </div>
                                <div class="detail-grid mt-4"><div><p><strong>Adresse:</strong> <span id="detailPersonAddressEl"></span></p></div><div><p><strong>Telefon:</strong> <span id="detailPersonPhoneEl"></span></p></div><div><p><strong>Beruf:</strong> <span id="detailPersonOccupationEl"></span></p></div><div><p><strong>Fahndungsstatus:</strong> <span id="detailPersonWantedStatusOutputEl"></span></p></div></div>
                                <p><strong>Merkmale:</strong> <span id="detailPersonFeaturesEl"></span></p><p><strong>Bekannte Fahrzeuge:</strong> <span id="detailPersonVehiclesListEl"></span></p><p><strong>Lizenzen:</strong> <span id="detailPersonLicensesEl"></span></p>
                                <h5 class="mt-3 font-semibold text-sm">Vorstrafen:</h5><ul id="detailPersonPriorsEl" class="list-disc pl-5 text-sm"><li>Keine Einträge</li></ul>
                                <h5 class="mt-3 font-semibold text-sm">Notizen:</h5><p id="detailPersonNotesEl" class="text-sm bg-white p-2 border rounded">Keine Notizen vorhanden.</p>
                            </div>
                        </div>

                        <div id="vehicleSearchContent" class="hidden copnet-section">
                            <div class="section-header"><h3>Fahrzeugsuche</h3><button id="createNewVehicleBtnEl"><i class="fas fa-car-plus"></i> Neues Fahrzeug erfassen</button></div>
                            <div class="search-bar"><input type="text" id="vehicleSearchPlateInputEl" placeholder="Kennzeichen..."><input type="text" id="vehicleSearchOwnerIdInputEl" placeholder="Halter Bürger-ID..."><button id="vehicleSearchBtnEl"><i class="fas fa-search"></i> Suchen</button></div>
                            <div id="vehicleResultsAreaEl" class="results-area"><p class="text-gray-500">Bitte Suchkriterien eingeben.</p></div>
                            <div id="vehicleDetailViewEl" class="detail-view hidden">
                                <div class="flex items-start gap-4">
                                    <img id="detailVehicleImageEl" src="https://placehold.co/150x100/cccccc/ffffff?text=Fahrzeug" alt="Fahrzeugbild" class="vehicle-pic" onerror="this.src='https://placehold.co/150x100/cccccc/ffffff?text=Fahrzeug';">
                                    <div><h4>Kennzeichen: <span id="detailVehiclePlateEl"></span> <span id="detailVehicleWantedFlagEl" class="flag hidden"></span></h4><p><strong>Marke:</strong> <span id="detailVehicleMakeEl"></span></p><p><strong>Modell:</strong> <span id="detailVehicleModelEl"></span></p></div>
                                    <button id="editVehicleBtnEl" class="ml-auto secondary"><i class="fas fa-edit"></i> Bearbeiten</button>
                                </div>
                                <div class="detail-grid mt-4"><div><p><strong>Farbe:</strong> <span id="detailVehicleColorEl"></span></p></div><div><p><strong>Halter:</strong> <span id="detailVehicleOwnerNameEl"></span> (ID: <span id="detailVehicleOwnerIdEl"></span>)</p></div><div><p><strong>Fahndungsstatus:</strong> <span id="detailVehicleWantedStatusOutputEl"></span></p></div></div>
                                <h5 class="mt-3 font-semibold text-sm">Notizen zum Fahrzeug:</h5><p id="detailVehicleNotesEl" class="text-sm bg-white p-2 border rounded">Keine Notizen vorhanden.</p>
                            </div>
                        </div>

                        <div id="dispatchContent" class="hidden copnet-section">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1">
                                    <h3>Einheiten im Dienst</h3>
                                    <div id="unitManagementSectionEl" class="mb-4 p-3 border rounded-md bg-gray-50">
                                        <label for="unitIdInputEl" class="block text-sm font-medium">Meine Einheit-ID:</label>
                                        <input type="text" id="unitIdInputEl" placeholder="z.B. 1-ADAM-12" class="mb-2">
                                        <label for="unitStatusSelectEl" class="block text-sm font-medium">Status:</label>
                                        <select id="unitStatusSelectEl" class="mb-2">
                                            <option value="Verfügbar">Verfügbar</option><option value="Im Einsatz">Im Einsatz</option>
                                            <option value="Pause">Pause</option><option value="Nicht im Dienst">Nicht im Dienst</option>
                                        </select>
                                        <button id="updateUnitStatusBtnEl" class="w-full">Status aktualisieren / Anmelden</button>
                                    </div>
                                    <div id="activeUnitsListEl" class="results-area"></div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="section-header"><h3>Aktive Einsätze</h3><button id="createNewIncidentBtnEl"><i class="fas fa-plus-circle"></i> Neuen Einsatz erstellen</button></div>
                                    <div id="activeIncidentsListEl" class="results-area"><table><thead><tr><th>ID</th><th>Typ</th><th>Priorität</th><th>Ort</th><th>Status</th><th>Einheiten</th><th>Aktionen</th></tr></thead><tbody id="activeIncidentsTableBodyEl"><tr><td colspan="7" class="text-center text-gray-500">Keine aktiven Einsätze.</td></tr></tbody></table></div>
                                </div>
                            </div>
                            <div id="incidentDetailViewEl" class="detail-view hidden mt-6">
                                <h4>Einsatzdetails: #<span id="detailIncidentIdEl"></span></h4>
                                <p><strong>Typ:</strong> <span id="detailIncidentTypeEl"></span></p><p><strong>Ort:</strong> <span id="detailIncidentLocationEl"></span></p>
                                <p><strong>Priorität:</strong> <span id="detailIncidentPriorityEl"></span></p><p><strong>Status:</strong> <span id="detailIncidentStatusEl"></span></p>
                                <p><strong>Beschreibung:</strong> <span id="detailIncidentDescriptionEl"></span></p><p><strong>Zugewiesene Einheiten:</strong> <span id="detailIncidentUnitsEl"></span></p>
                                <div class="mt-4">
                                    <label for="assignUnitToIncidentSelectEl" class="block text-sm font-medium">Einheit zuweisen:</label>
                                    <select id="assignUnitToIncidentSelectEl" class="mb-2"></select>
                                    <button id="assignUnitBtnEl" class="mr-2">Zuweisen</button>
                                    <button id="createReportFromIncidentBtnEl" class="secondary">Bericht erstellen</button>
                                </div>
                            </div>
                        </div>

                        <div id="boloContent" class="hidden copnet-section"><h3>Fahndungsliste (BOLO)</h3><div class="results-area"><table><thead><tr><th>Priorität</th><th>Typ</th><th>Beschreibung</th><th>Letzte Sichtung</th><th>Aktionen</th></tr></thead><tbody><tr><td>Hoch</td><td>Person</td><td>John Doe, bewaffneter Raubüberfall</td><td>Davis, Gestern</td><td><button class="text-xs p-1">Details</button></td></tr></tbody></table></div></div>

                        <div id="reportsContent" class="hidden copnet-section">
                            <div class="section-header"><h3>Berichtswesen</h3></div>
                            <div id="reportsListAreaEl" class="results-area"><table><thead><tr><th>Bericht-ID</th><th>Einsatz-ID</th><th>Titel</th><th>Datum</th><th>Beamter</th><th>Aktionen</th></tr></thead><tbody id="reportsTableBodyEl"><tr><td colspan="6" class="text-center text-gray-500">Keine Berichte vorhanden.</td></tr></tbody></table></div>
                            <div id="reportDetailViewEl" class="detail-view hidden">
                                <h4>Bericht: #<span id="detailReportIdEl"></span> (Einsatz: #<span id="detailReportIncidentIdEl"></span>)</h4>
                                <p><strong>Datum/Zeit:</strong> <span id="detailReportTimestampEl"></span></p><p><strong>Verfasser:</strong> <span id="detailReportOfficerEl"></span></p>
                                <p><strong>Ort:</strong> <span id="detailReportLocationEl"></span></p><p><strong>Titel/Art:</strong> <span id="detailReportTitleEl"></span></p>
                                <h5 class="mt-3 font-semibold text-sm">Sachverhalt:</h5><p id="detailReportNarrativeEl" class="text-sm bg-white p-2 border rounded"></p>
                                <h5 class="mt-3 font-semibold text-sm">Beteiligte Personen:</h5><ul id="detailReportPersonsEl" class="list-disc pl-5 text-sm"></ul>
                                <h5 class="mt-3 font-semibold text-sm">Beteiligte Fahrzeuge:</h5><ul id="detailReportVehiclesEl" class="list-disc pl-5 text-sm"></ul>
                                <h5 class="mt-3 font-semibold text-sm">Maßnahmen:</h5><p id="detailReportActionsEl" class="text-sm"></p>
                            </div>
                        </div>
                        <div id="knowledgeBaseContent" class="hidden copnet-section"><h3>Gesetze & Wissensdatenbank</h3><div class="search-bar"><input type="text" placeholder="Suche nach Paragraph, Stichwort..."><button><i class="fas fa-search"></i> Suchen</button></div><div class="results-area"><p>Platzhalter.</p></div></div>
                    </div>
                </div>
            </div>
            <div class="resizer" id="resizerEl"></div>
        </div>

        <div id="createPersonModalEl" class="modal-overlay hidden"><div class="modal-box"><div class="modal-header"><h4>Personenakte</h4><button id="closeCreatePersonModalBtnEl" class="modal-close-btn">&times;</button></div><div class="modal-body"><form id="createPersonFormEl"><input type="hidden" id="editingPersonCitizenIdEl"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="personFirstNameEl">Vorname:</label><input type="text" id="personFirstNameEl" required></div><div><label for="personLastNameEl">Nachname:</label><input type="text" id="personLastNameEl" required></div><div><label for="personDobEl">Geburtsdatum:</label><input type="date" id="personDobEl"></div><div><label for="personCitizenIdEl">Bürger-ID:</label><input type="text" id="personCitizenIdEl"></div></div><label for="personAddressEl">Adresse:</label><input type="text" id="personAddressEl"><label for="personPhoneEl">Telefon:</label><input type="text" id="personPhoneEl"><label for="personOccupationEl">Beruf:</label><input type="text" id="personOccupationEl"><label for="personProfilePicUrlEl">Profilbild URL:</label><input type="text" id="personProfilePicUrlEl" placeholder="https://beispiel.de/bild.png"><label for="personFeaturesEl">Besondere Merkmale:</label><textarea id="personFeaturesEl"></textarea><label for="personLicensesEl">Lizenzen (kommagetrennt):</label><input type="text" id="personLicensesEl"><label for="personWantedStatusModalEl">Fahndungsstatus:</label><select id="personWantedStatusModalEl"><option value="Kein Eintrag">Kein Eintrag</option><option value="Gesucht">Gesucht</option><option value="Vorsicht">Vorsicht Geboten</option></select><label for="personNotesEl">Notizen:</label><textarea id="personNotesEl"></textarea></form></div><div class="modal-footer"><button type="button" id="savePersonBtnEl" class="mr-2">Speichern</button><button type="button" id="cancelPersonBtnEl" class="secondary">Abbrechen</button></div></div></div>
        <div id="createVehicleModalEl" class="modal-overlay hidden"><div class="modal-box"><div class="modal-header"><h4>Fahrzeugakte</h4><button id="closeCreateVehicleModalBtnEl" class="modal-close-btn">&times;</button></div><div class="modal-body"><form id="createVehicleFormEl"><input type="hidden" id="editingVehiclePlateEl"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="vehiclePlateEl">Kennzeichen:</label><input type="text" id="vehiclePlateEl" required></div><div><label for="vehicleMakeEl">Marke:</label><input type="text" id="vehicleMakeEl"></div><div><label for="vehicleModelEl">Modell:</label><input type="text" id="vehicleModelEl"></div><div><label for="vehicleColorEl">Farbe:</label><input type="text" id="vehicleColorEl"></div></div><label for="vehicleOwnerCitizenIdEl">Halter Bürger-ID (optional):</label><input type="text" id="vehicleOwnerCitizenIdEl"><label for="vehicleImageUrlEl">Fahrzeugbild URL:</label><input type="text" id="vehicleImageUrlEl" placeholder="https://beispiel.de/fahrzeug.png"><label for="vehicleWantedStatusModalEl">Fahndungsstatus:</label><select id="vehicleWantedStatusModalEl"><option value="Kein Eintrag">Kein Eintrag</option><option value="Gestohlen">Gestohlen</option><option value="Zur Fahndung (Verbrechen)">Zur Fahndung (Verbrechen)</option></select><label for="vehicleNotesEl">Notizen zum Fahrzeug:</label><textarea id="vehicleNotesEl"></textarea></form></div><div class="modal-footer"><button type="button" id="saveVehicleBtnEl" class="mr-2">Speichern</button><button type="button" id="cancelVehicleBtnEl" class="secondary">Abbrechen</button></div></div></div>
        <div id="createIncidentModalEl" class="modal-overlay hidden"><div class="modal-box"><div class="modal-header"><h4>Neuen Einsatz erstellen</h4><button id="closeCreateIncidentModalBtnEl" class="modal-close-btn">&times;</button></div><div class="modal-body"><form id="createIncidentFormEl"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="incidentTypeEl">Einsatztyp:</label><select id="incidentTypeEl"><option>Verkehrskontrolle</option><option>Einbruch</option><option>Raubüberfall</option><option>Schlägerei</option><option>Verdächtige Person</option><option>Sonstiges</option></select></div><div><label for="incidentPriorityEl">Priorität:</label><select id="incidentPriorityEl"><option value="Niedrig">Niedrig</option><option value="Mittel">Mittel</option><option value="Hoch">Hoch</option></select></div></div><label for="incidentLocationEl">Ort:</label><input type="text" id="incidentLocationEl" required><label for="incidentCallerNameEl">Anrufer Name (optional):</label><input type="text" id="incidentCallerNameEl"><label for="incidentCallerPhoneEl">Anrufer Telefon (optional):</label><input type="text" id="incidentCallerPhoneEl"><label for="incidentDescriptionEl">Kurzbeschreibung:</label><textarea id="incidentDescriptionEl" required></textarea></form></div><div class="modal-footer"><button type="button" id="saveIncidentBtnEl" class="mr-2">Einsatz erstellen</button><button type="button" id="cancelIncidentBtnEl" class="secondary">Abbrechen</button></div></div></div>
        <div id="createReportModalEl" class="modal-overlay hidden"><div class="modal-box" style="max-width: 800px;"><div class="modal-header"><h4>Bericht erstellen</h4><button id="closeCreateReportModalBtnEl" class="modal-close-btn">&times;</button></div><div class="modal-body"><form id="createReportFormEl"><input type="hidden" id="reportIncidentIdInputEl"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="reportTitleEl">Titel/Art des Vorfalls:</label><input type="text" id="reportTitleEl" required></div><div><label for="reportLocationEl">Ort des Vorfalls:</label><input type="text" id="reportLocationEl" required></div></div><label for="reportNarrativeEl">Sachverhalt:</label><textarea id="reportNarrativeEl" rows="5" required></textarea><label for="reportPersonsInvolvedEl">Beteiligte Personen (Namen, Rollen - pro Zeile):</label><textarea id="reportPersonsInvolvedEl" rows="3"></textarea><label for="reportVehiclesInvolvedEl">Beteiligte Fahrzeuge (Kennzeichen - pro Zeile):</label><textarea id="reportVehiclesInvolvedEl" rows="2"></textarea><label for="reportActionsTakenEl">Getroffene Maßnahmen:</label><textarea id="reportActionsTakenEl" rows="3"></textarea></form></div><div class="modal-footer"><button type="button" id="saveReportBtnEl" class="mr-2">Bericht speichern</button><button type="button" id="cancelReportBtnEl" class="secondary">Abbrechen</button></div></div></div>

        <div class="macos-dock"><div class="macos-dock-item" id="finderIconEl"><i class="fas fa-folder-open"></i><span class="tooltip">Finder</span></div><div class="macos-dock-item" id="launchpadIconEl"><i class="fas fa-th-large"></i><span class="tooltip">Launchpad</span></div><div class="macos-dock-item" id="cadAppIconEl"><i class="fas fa-shield-alt"></i><span class="tooltip">LSPD CAD</span></div><div class="macos-dock-item"><i class="fas fa-envelope"></i><span class="tooltip">Mail</span></div><div class="macos-dock-item"><i class="fab fa-safari"></i><span class="tooltip">Safari</span></div><div class="macos-dock-item"><i class="fas fa-trash"></i><span class="tooltip">Papierkorb</span></div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bootScreenOverlayEl = document.getElementById('bootScreenOverlay');
            const bootProgressBarEl = document.getElementById('bootProgressBar');
            const macOSLoginScreenEl = document.getElementById('macOSLoginScreen');
            const macOSPasswordInputEl = document.getElementById('macOSPasswordInput');
            const macOSLoginButtonEl = document.getElementById('macOSLoginButton');
            const macOSLoginErrorEl = document.getElementById('macOSLoginError');
            const macOSLoginUserNameEl = document.getElementById('macOSLoginUserName');
            const shutdownScreenOverlayEl = document.getElementById('shutdownScreenOverlay');
            const desktopEnvironmentEl = document.getElementById('desktopEnvironment');
            const powerButtonScreenEl = document.getElementById('powerButtonScreenEl'); // New
            const powerButtonIconEl = document.getElementById('powerButtonIcon'); // New


            const appleLogoMenuContainerEl = document.getElementById('appleLogoMenuContainer');
            const appleMenuDropdownEl = document.getElementById('appleMenuDropdownEl');
            const logoutMacOSMenuItemEl = document.getElementById('logoutMacOSMenuItem');
            const shutdownMenuItemEl = document.getElementById('shutdownMenuItem');

            const cadWindowEl = document.getElementById('cadWindowEl');
            const windowHeaderEl = document.getElementById('windowHeaderEl');
            const closeButtonEl = document.getElementById('closeButtonEl');
            const minimizeButtonEl = document.getElementById('minimizeButtonEl');
            const maximizeButtonEl = document.getElementById('maximizeButtonEl');
            const cadAppIconEl = document.getElementById('cadAppIconEl');
            const resizerEl = document.getElementById('resizerEl');
            const currentTimeEl = document.getElementById('currentTimeEl');


            const officerIdDisplayInCADEl = document.getElementById('officerIdDisplayInCADEl');
            const loggedInOfficerNameEl = document.getElementById('loggedInOfficerNameEl');

            const personSearchNameInputEl = document.getElementById('personSearchNameInputEl');
            const personSearchIdInputEl = document.getElementById('personSearchIdInputEl');
            const personSearchBtnEl = document.getElementById('personSearchBtnEl');
            const personResultsAreaEl = document.getElementById('personResultsAreaEl');
            const personDetailViewEl = document.getElementById('personDetailViewEl');
            const detailPersonProfilePicEl = document.getElementById('detailPersonProfilePicEl');
            const detailViewPersonNameEl = document.getElementById('detailViewPersonNameEl');
            const detailViewPersonWantedFlagEl = document.getElementById('detailViewPersonWantedFlagEl');
            const detailPersonIdEl = document.getElementById('detailPersonIdEl');
            const detailPersonDobEl = document.getElementById('detailPersonDobEl');
            const detailPersonAddressEl = document.getElementById('detailPersonAddressEl');
            const detailPersonPhoneEl = document.getElementById('detailPersonPhoneEl');
            const detailPersonOccupationEl = document.getElementById('detailPersonOccupationEl');
            const detailPersonWantedStatusOutputEl = document.getElementById('detailPersonWantedStatusOutputEl');
            const detailPersonFeaturesEl = document.getElementById('detailPersonFeaturesEl');
            const detailPersonVehiclesListEl = document.getElementById('detailPersonVehiclesListEl');
            const detailPersonLicensesEl = document.getElementById('detailPersonLicensesEl');
            const detailPersonPriorsEl = document.getElementById('detailPersonPriorsEl');
            const detailPersonNotesEl = document.getElementById('detailPersonNotesEl');
            const editPersonBtnEl = document.getElementById('editPersonBtnEl');

            const createNewPersonBtnEl = document.getElementById('createNewPersonBtnEl');
            const createPersonModalEl = document.getElementById('createPersonModalEl');
            const closeCreatePersonModalBtnEl = document.getElementById('closeCreatePersonModalBtnEl');
            const savePersonBtnEl = document.getElementById('savePersonBtnEl');
            const cancelPersonBtnEl = document.getElementById('cancelPersonBtnEl');
            const createPersonFormEl = document.getElementById('createPersonFormEl');
            const personModalFirstNameEl = document.getElementById('personFirstNameEl');
            const personModalLastNameEl = document.getElementById('personLastNameEl');
            const personModalDobEl = document.getElementById('personDobEl');
            const personModalCitizenIdEl = document.getElementById('personCitizenIdEl');
            const personModalAddressEl = document.getElementById('personAddressEl');
            const personModalPhoneEl = document.getElementById('personPhoneEl');
            const personModalOccupationEl = document.getElementById('personOccupationEl');
            const personModalProfilePicUrlEl = document.getElementById('personProfilePicUrlEl');
            const personModalFeaturesEl = document.getElementById('personFeaturesEl');
            const personModalLicensesEl = document.getElementById('personLicensesEl');
            const personModalWantedStatusEl = document.getElementById('personWantedStatusModalEl');
            const personModalNotesEl = document.getElementById('personNotesEl');
            const editingPersonCitizenIdFieldEl = document.getElementById('editingPersonCitizenIdEl');

            const createNewVehicleBtnEl = document.getElementById('createNewVehicleBtnEl');
            const createVehicleModalEl = document.getElementById('createVehicleModalEl');
            const closeCreateVehicleModalBtnEl = document.getElementById('closeCreateVehicleModalBtnEl');
            const saveVehicleBtnEl = document.getElementById('saveVehicleBtnEl');
            const cancelVehicleBtnEl = document.getElementById('cancelVehicleBtnEl');
            const createVehicleFormEl = document.getElementById('createVehicleFormEl');
            const vehicleSearchPlateInputEl = document.getElementById('vehicleSearchPlateInputEl');
            const vehicleSearchOwnerIdInputEl = document.getElementById('vehicleSearchOwnerIdInputEl');
            const vehicleSearchBtnEl = document.getElementById('vehicleSearchBtnEl');
            const vehicleResultsAreaEl = document.getElementById('vehicleResultsAreaEl');
            const vehicleDetailViewEl = document.getElementById('vehicleDetailViewEl');
            const detailVehicleImageEl = document.getElementById('detailVehicleImageEl');
            const detailVehiclePlateEl = document.getElementById('detailVehiclePlateEl');
            const detailVehicleWantedFlagEl = document.getElementById('detailVehicleWantedFlagEl');
            const detailVehicleMakeEl = document.getElementById('detailVehicleMakeEl');
            const detailVehicleModelEl = document.getElementById('detailVehicleModelEl');
            const detailVehicleColorEl = document.getElementById('detailVehicleColorEl');
            const detailVehicleOwnerNameEl = document.getElementById('detailVehicleOwnerNameEl');
            const detailVehicleOwnerIdEl = document.getElementById('detailVehicleOwnerIdEl');
            const detailVehicleWantedStatusOutputEl = document.getElementById('detailVehicleWantedStatusOutputEl');
            const detailVehicleNotesEl = document.getElementById('detailVehicleNotesEl');
            const editVehicleBtnEl = document.getElementById('editVehicleBtnEl');
            const vehicleModalPlateEl = document.getElementById('vehiclePlateEl');
            const vehicleModalMakeEl = document.getElementById('vehicleMakeEl');
            const vehicleModalModelEl = document.getElementById('vehicleModelEl');
            const vehicleModalColorEl = document.getElementById('vehicleColorEl');
            const vehicleModalOwnerCitizenIdEl = document.getElementById('vehicleOwnerCitizenIdEl');
            const vehicleModalImageUrlEl = document.getElementById('vehicleImageUrlEl');
            const vehicleModalWantedStatusEl = document.getElementById('vehicleWantedStatusModalEl');
            const vehicleModalNotesEl = document.getElementById('vehicleNotesEl');
            const editingVehiclePlateFieldEl = document.getElementById('editingVehiclePlateEl');

            const unitIdInputEl = document.getElementById('unitIdInputEl');
            const unitStatusSelectEl = document.getElementById('unitStatusSelectEl');
            const updateUnitStatusBtnEl = document.getElementById('updateUnitStatusBtnEl');
            const activeUnitsListEl = document.getElementById('activeUnitsListEl');
            const createNewIncidentBtnEl = document.getElementById('createNewIncidentBtnEl');
            const activeIncidentsTableBodyEl = document.getElementById('activeIncidentsTableBodyEl'); // Corrected selector
            const incidentDetailViewEl = document.getElementById('incidentDetailViewEl');
            const detailIncidentIdEl = document.getElementById('detailIncidentIdEl');
            const detailIncidentTypeEl = document.getElementById('detailIncidentTypeEl');
            const detailIncidentLocationEl = document.getElementById('detailIncidentLocationEl');
            const detailIncidentPriorityEl = document.getElementById('detailIncidentPriorityEl');
            const detailIncidentStatusEl = document.getElementById('detailIncidentStatusEl');
            const detailIncidentDescriptionEl = document.getElementById('detailIncidentDescriptionEl');
            const detailIncidentUnitsEl = document.getElementById('detailIncidentUnitsEl');
            const assignUnitToIncidentSelectEl = document.getElementById('assignUnitToIncidentSelectEl');
            const assignUnitBtnEl = document.getElementById('assignUnitBtnEl');
            const createReportFromIncidentBtnEl = document.getElementById('createReportFromIncidentBtnEl');

            const createIncidentModalEl = document.getElementById('createIncidentModalEl');
            const closeCreateIncidentModalBtnEl = document.getElementById('closeCreateIncidentModalBtnEl');
            const saveIncidentBtnEl = document.getElementById('saveIncidentBtnEl');
            const cancelIncidentBtnEl = document.getElementById('cancelIncidentBtnEl');
            const createIncidentFormEl = document.getElementById('createIncidentFormEl');
            const incidentModalTypeEl = document.getElementById('incidentTypeEl');
            const incidentModalPriorityEl = document.getElementById('incidentPriorityEl');
            const incidentModalLocationEl = document.getElementById('incidentLocationEl');
            const incidentModalCallerNameEl = document.getElementById('incidentCallerNameEl');
            const incidentModalCallerPhoneEl = document.getElementById('incidentCallerPhoneEl');
            const incidentModalDescriptionEl = document.getElementById('incidentDescriptionEl');

            const reportsListAreaTableBodyEl = document.getElementById('reportsTableBodyEl'); // Corrected selector
            const reportDetailViewEl = document.getElementById('reportDetailViewEl');
            const detailReportIdEl = document.getElementById('detailReportIdEl');
            const detailReportIncidentIdEl = document.getElementById('detailReportIncidentIdEl');
            const detailReportTimestampEl = document.getElementById('detailReportTimestampEl');
            const detailReportOfficerEl = document.getElementById('detailReportOfficerEl');
            const detailReportLocationEl = document.getElementById('detailReportLocationEl');
            const detailReportTitleEl = document.getElementById('detailReportTitleEl');
            const detailReportNarrativeEl = document.getElementById('detailReportNarrativeEl');
            const detailReportPersonsEl = document.getElementById('detailReportPersonsEl');
            const detailReportVehiclesEl = document.getElementById('detailReportVehiclesEl');
            const detailReportActionsEl = document.getElementById('detailReportActionsEl');

            const createReportModalEl = document.getElementById('createReportModalEl');
            const closeCreateReportModalBtnEl = document.getElementById('closeCreateReportModalBtnEl');
            const saveReportBtnEl = document.getElementById('saveReportBtnEl');
            const cancelReportBtnEl = document.getElementById('cancelReportBtnEl');
            const createReportFormEl = document.getElementById('createReportFormEl');
            const reportModalIncidentIdInputEl = document.getElementById('reportIncidentIdInputEl');
            const reportModalTitleEl = document.getElementById('reportTitleEl');
            const reportModalLocationEl = document.getElementById('reportLocationEl');
            const reportModalNarrativeEl = document.getElementById('reportNarrativeEl');
            const reportModalPersonsInvolvedEl = document.getElementById('reportPersonsInvolvedEl');
            const reportModalVehiclesInvolvedEl = document.getElementById('reportVehiclesInvolvedEl');
            const reportModalActionsTakenEl = document.getElementById('reportActionsTakenEl');
            const unitStatusListDashboardEl = document.getElementById('unitStatusListDashboardEl');
            const dashboardActiveIncidentsListEl = document.getElementById('dashboardActiveIncidentsList');
            const dashboardMyReportsListEl = document.getElementById('dashboardMyReportsList');


            const MOCK_DIENSTNUMMER = "PD-61";
            const MOCK_PASSWORT = "lspd_61";
            let pcState = 'off';
            let currentLoggedInUser = "";
            let editingPersonId = null;
            let editingVehiclePlate = null;
            let currentActiveUnitId = null;

            const MENU_BAR_HEIGHT = 28;
            const DOCK_APPROX_HEIGHT = 70;

            const mockPersonDatabase = [
                {
                    firstName: "John", lastName: "Doe", dob: "1985-05-15", citizenId: "JD12345",
                    address: "123 Vinewood Blvd, Los Santos", phone: "555-0100", occupation: "Unbekannt",
                    profilePicUrl: "https://placehold.co/100x100/3498db/ffffff?text=JD",
                    features: "Narbe über dem linken Auge, Tattoo (Drache) auf dem rechten Unterarm.",
                    vehicles: ["SULTANRS1"], licenses: "Führerschein Klasse B, Waffenschein (abgelaufen)",
                    priors: ["Unerlaubter Waffenbesitz (2020)", "Mehrfacher Diebstahl (2018, 2019)"],
                    notes: "Vorsicht, gilt als gewaltbereit. Oft im Strawberry-Viertel gesehen.",
                    wantedStatus: "Gesucht",
                }
            ];
            const mockVehicleDatabase = [
                {
                    plate: "SULTANRS1", make: "Karin", model: "Sultan RS", color: "Blau",
                    ownerCitizenId: "JD12345", imageUrl: "https://placehold.co/150x100/3498db/ffffff?text=Sultan+RS",
                    wantedStatus: "Kein Eintrag", notes: "Auffällige Spoiler, Sportauspuff."
                }
            ];
            const mockUnitsOnDuty = [];
            const mockIncidentsDatabase = [];
            const mockReportsDatabase = [];

            function setVisibility(element, visible, displayType = 'flex') {
                if (!element) return;
                if (visible) {
                    element.classList.remove('hidden');
                    if (displayType === 'flex') element.classList.add('flex-display');
                    else element.style.display = displayType;
                } else {
                    element.classList.add('hidden');
                    element.classList.remove('flex-display');
                    if (element.style.display === displayType) element.style.display = '';
                }
            }

            function generateUniqueId(prefix = "") { return prefix + Date.now().toString(36) + Math.random().toString(36).substring(2); }

            function showPowerButtonScreen() {
                pcState = 'off';
                setVisibility(powerButtonScreenEl, true);
                setVisibility(bootScreenOverlayEl, false);
                setVisibility(macOSLoginScreenEl, false);
                setVisibility(desktopEnvironmentEl, false);
                setVisibility(shutdownScreenOverlayEl, false);
                if(cadWindowEl) cadWindowEl.classList.remove('visible');
            }


            function startBootProcess() {
                if (pcState !== 'off' && pcState !== 'shutting_down_complete') return; // Allow boot only if fully off
                pcState = 'booting';
                setVisibility(powerButtonScreenEl, false); // Hide power button
                setVisibility(bootScreenOverlayEl, true);
                setVisibility(macOSLoginScreenEl, false);
                setVisibility(desktopEnvironmentEl, false);
                setVisibility(shutdownScreenOverlayEl, false);
                if(cadWindowEl) cadWindowEl.classList.remove('visible');

                let progress = 0;
                if(bootProgressBarEl) bootProgressBarEl.style.width = '0%'; // Reset progress bar

                const interval = setInterval(() => {
                    progress += Math.random() * 10 + 5;
                    if (progress >= 100) {
                        progress = 100;
                        if(bootProgressBarEl) bootProgressBarEl.style.width = progress + '%';
                        clearInterval(interval);
                        setTimeout(() => {
                            setVisibility(bootScreenOverlayEl, false); setVisibility(macOSLoginScreenEl, true);
                            if(macOSPasswordInputEl) { macOSPasswordInputEl.value = ""; macOSPasswordInputEl.focus(); }
                            if(macOSLoginErrorEl) macOSLoginErrorEl.textContent = "";
                            if(macOSLoginUserNameEl) macOSLoginUserNameEl.textContent = MOCK_DIENSTNUMMER;
                            pcState = 'at_mac_login_screen';
                        }, 500);
                    }
                   if(bootProgressBarEl) bootProgressBarEl.style.width = progress + '%';
                }, 150);
            }
            if(powerButtonIconEl) {
                powerButtonIconEl.addEventListener('click', startBootProcess);
            }


            function handleMacOSLogin() {
                if (pcState !== 'at_mac_login_screen' || !macOSPasswordInputEl || !macOSLoginErrorEl) return;
                if (macOSPasswordInputEl.value === MOCK_PASSWORT) {
                    currentLoggedInUser = MOCK_DIENSTNUMMER;
                    setVisibility(macOSLoginScreenEl, false); setVisibility(desktopEnvironmentEl, true);
                    pcState = 'desktop_active'; macOSLoginErrorEl.textContent = "";
                    if(officerIdDisplayInCADEl) officerIdDisplayInCADEl.textContent = currentLoggedInUser;
                    if(loggedInOfficerNameEl) loggedInOfficerNameEl.textContent = currentLoggedInUser;
                    if(logoutMacOSMenuItemEl) logoutMacOSMenuItemEl.textContent = `Abmelden (${currentLoggedInUser})...`;
                    switchCadContent('dashboardContent');
                    renderUnitStatusDashboard(); renderActiveIncidents(); renderReportsList(); renderAvailableUnitsForAssignment();
                } else {
                    macOSLoginErrorEl.textContent = 'Passwort ungültig.'; macOSPasswordInputEl.value = ''; macOSPasswordInputEl.focus();
                }
            }

            if (macOSLoginButtonEl) macOSLoginButtonEl.addEventListener('click', handleMacOSLogin);
            if (macOSPasswordInputEl) macOSPasswordInputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleMacOSLogin(); }});

            function handleMacOSLogout() {
                if (pcState !== 'desktop_active') return;
                if (currentActiveUnitId) {
                    const unitIndex = mockUnitsOnDuty.findIndex(u => u.unitId === currentActiveUnitId && u.officer === currentLoggedInUser);
                    if (unitIndex > -1) mockUnitsOnDuty.splice(unitIndex, 1);
                    currentActiveUnitId = null;
                    if(unitIdInputEl) { unitIdInputEl.value = ""; unitIdInputEl.disabled = false; }
                    if(updateUnitStatusBtnEl) updateUnitStatusBtnEl.textContent = "Status aktualisieren / Anmelden";
                    renderActiveUnits(); renderUnitStatusDashboard();
                }
                currentLoggedInUser = ""; setVisibility(desktopEnvironmentEl, false);
                if(cadWindowEl) cadWindowEl.classList.remove('visible');
                setVisibility(macOSLoginScreenEl, true);
                if(macOSPasswordInputEl) { macOSPasswordInputEl.value = ""; macOSPasswordInputEl.focus(); }
                if(macOSLoginErrorEl) macOSLoginErrorEl.textContent = "";
                pcState = 'at_mac_login_screen';
                if(appleMenuDropdownEl) appleMenuDropdownEl.classList.add('hidden');
            }

            if (logoutMacOSMenuItemEl) logoutMacOSMenuItemEl.addEventListener('click', (e) => { e.stopPropagation(); handleMacOSLogout(); });

            function startShutdownProcess() {
                if (pcState !== 'desktop_active' && pcState !== 'at_mac_login_screen') return;
                if (currentActiveUnitId) {
                    const unitIndex = mockUnitsOnDuty.findIndex(u => u.unitId === currentActiveUnitId && u.officer === currentLoggedInUser);
                    if (unitIndex > -1) mockUnitsOnDuty.splice(unitIndex, 1);
                }
                pcState = 'shutting_down';
                setVisibility(desktopEnvironmentEl, false); setVisibility(macOSLoginScreenEl, false);
                if(cadWindowEl) cadWindowEl.classList.remove('visible');
                setVisibility(shutdownScreenOverlayEl, true, 'flex');
                setTimeout(() => {
                    setVisibility(shutdownScreenOverlayEl, false);
                    if(bootProgressBarEl) bootProgressBarEl.style.width = '0%';
                    pcState = 'shutting_down_complete'; // New intermediate state before 'off'
                    showPowerButtonScreen(); // Show power button screen
                }, 3000);
            }

            if (appleLogoMenuContainerEl && appleMenuDropdownEl) {
                appleLogoMenuContainerEl.addEventListener('click', (e) => { e.stopPropagation(); if (pcState === 'desktop_active') appleMenuDropdownEl.classList.toggle('hidden'); });
                document.addEventListener('click', (e) => { if (appleMenuDropdownEl && !appleMenuDropdownEl.classList.contains('hidden') && !appleLogoMenuContainerEl.contains(e.target)) appleMenuDropdownEl.classList.add('hidden'); });
            }
            if (shutdownMenuItemEl) shutdownMenuItemEl.addEventListener('click', (e) => { e.stopPropagation(); if(appleMenuDropdownEl) appleMenuDropdownEl.classList.add('hidden'); startShutdownProcess(); });

            let offsetX, offsetY, isDraggingWindow = false;
            if (windowHeaderEl) {
                windowHeaderEl.addEventListener('mousedown', (e) => {
                    if (pcState !== 'desktop_active' || e.button !== 0 || (cadWindowEl && cadWindowEl.classList.contains('maximized'))) return;
                    isDraggingWindow = true; offsetX = e.clientX - cadWindowEl.offsetLeft; offsetY = e.clientY - cadWindowEl.offsetTop;
                    cadWindowEl.style.transition = 'none';
                });
            }
            document.addEventListener('mousemove', (e) => {
                if (pcState !== 'desktop_active' || !isDraggingWindow || (cadWindowEl && cadWindowEl.classList.contains('maximized'))) return;
                let newX = e.clientX - offsetX, newY = e.clientY - offsetY;
                newX = Math.max(0, Math.min(newX, window.innerWidth - cadWindowEl.offsetWidth));
                newY = Math.max(MENU_BAR_HEIGHT, Math.min(newY, window.innerHeight - cadWindowEl.offsetHeight));
                cadWindowEl.style.left = newX + 'px'; cadWindowEl.style.top = newY + 'px';
            });
            document.addEventListener('mouseup', () => { if (isDraggingWindow) { isDraggingWindow = false; if(cadWindowEl) cadWindowEl.style.transition = ''; }});

            if (closeButtonEl) closeButtonEl.addEventListener('click', (e) => { if (pcState === 'desktop_active' && cadWindowEl) {e.stopPropagation(); cadWindowEl.classList.remove('visible');}});
            if (minimizeButtonEl) minimizeButtonEl.addEventListener('click', (e) => { if (pcState === 'desktop_active' && cadWindowEl) {e.stopPropagation(); cadWindowEl.classList.remove('visible');}});

            let isCadMaximized = false; let originalCadSize = {};
            if (maximizeButtonEl && cadWindowEl) {
                maximizeButtonEl.addEventListener('click', (e) => {
                    if (pcState !== 'desktop_active') return; e.stopPropagation();
                    if (!isCadMaximized) {
                        originalCadSize = { width: cadWindowEl.style.width, height: cadWindowEl.style.height, top: cadWindowEl.style.top, left: cadWindowEl.style.left, borderRadius: cadWindowEl.style.borderRadius };
                        Object.assign(cadWindowEl.style, { top: `${MENU_BAR_HEIGHT}px`, left: '0px', width: '100vw', height: `calc(100vh - ${MENU_BAR_HEIGHT}px - ${DOCK_APPROX_HEIGHT}px)`});
                        cadWindowEl.classList.add('maximized'); isCadMaximized = true;
                        if(resizerEl) resizerEl.style.display = 'none';
                    } else {
                        Object.assign(cadWindowEl.style, { top: originalCadSize.top || '50px', left: originalCadSize.left || '50px', width: originalCadSize.width || '80vw', height: originalCadSize.height || '78vh', borderRadius: originalCadSize.borderRadius || '12px' });
                        cadWindowEl.classList.remove('maximized'); isCadMaximized = false;
                        if(resizerEl) resizerEl.style.display = 'block';
                    }
                });
            }

            if (cadAppIconEl) {
                cadAppIconEl.addEventListener('click', () => {
                    if (pcState !== 'desktop_active' || !cadWindowEl) return;
                    cadWindowEl.classList.toggle('visible');
                    if (cadWindowEl.classList.contains('visible')) cadWindowEl.style.zIndex = parseInt(getComputedStyle(cadWindowEl).zIndex || '900', 10) + 1;
                });
            }

            const sidebarItems = document.querySelectorAll('.cad-sidebar-item');
            const contentSections = document.querySelectorAll('.cad-main-content > div[id$="Content"]');
            function switchCadContent(targetId) {
                contentSections.forEach(section => {setVisibility(section, false); section.classList.remove('active-content'); });
                sidebarItems.forEach(item => { item.classList.remove('active'); });
                const targetContent = document.getElementById(targetId);
                const targetSidebarItem = document.querySelector(`.cad-sidebar-item[data-target="${targetId}"]`);
                if (targetContent) { setVisibility(targetContent, true, 'block'); targetContent.classList.add('active-content');}
                if (targetSidebarItem) { targetSidebarItem.classList.add('active'); }
            }
            sidebarItems.forEach(item => item.addEventListener('click', () => { if (pcState === 'desktop_active') switchCadContent(item.getAttribute('data-target')); }));

            function populatePersonModal(person) {
                editingPersonCitizenIdFieldEl.value = person.citizenId;
                personModalFirstNameEl.value = person.firstName;
                personModalLastNameEl.value = person.lastName;
                personModalDobEl.value = person.dob;
                personModalCitizenIdEl.value = person.citizenId;
                personModalCitizenIdEl.readOnly = true;
                personModalAddressEl.value = person.address;
                personModalPhoneEl.value = person.phone;
                personModalOccupationEl.value = person.occupation;
                personModalProfilePicUrlEl.value = person.profilePicUrl;
                personModalFeaturesEl.value = person.features;
                personModalLicensesEl.value = person.licenses;
                personModalWantedStatusEl.value = person.wantedStatus;
                personModalNotesEl.value = person.notes;
                document.querySelector('#createPersonModalEl .modal-header h4').textContent = "Personenakte bearbeiten";
                setVisibility(createPersonModalEl, true);
            }

            if (editPersonBtnEl) {
                editPersonBtnEl.addEventListener('click', () => {
                    const citizenId = detailPersonIdEl.textContent;
                    const personToEdit = mockPersonDatabase.find(p => p.citizenId === citizenId);
                    if (personToEdit) populatePersonModal(personToEdit);
                    else alert("Fehler: Person zum Bearbeiten nicht gefunden.");
                });
            }

            function displayPersonDetails(person) {
                 if (!personDetailViewEl || !person) { setVisibility(personDetailViewEl, false); return; }
                if(detailPersonProfilePicEl) detailPersonProfilePicEl.src = person.profilePicUrl || 'https://placehold.co/100x100/cccccc/ffffff?text=Bild';
                if(detailViewPersonNameEl) detailViewPersonNameEl.textContent = `${person.firstName} ${person.lastName}`;
                if(detailPersonIdEl) detailPersonIdEl.textContent = person.citizenId || '-';
                if(detailPersonDobEl) detailPersonDobEl.textContent = person.dob || '-';
                if(detailPersonAddressEl) detailPersonAddressEl.textContent = person.address || '-';
                if(detailPersonPhoneEl) detailPersonPhoneEl.textContent = person.phone || '-';
                if(detailPersonOccupationEl) detailPersonOccupationEl.textContent = person.occupation || '-';
                if(detailPersonWantedStatusOutputEl) detailPersonWantedStatusOutputEl.textContent = person.wantedStatus || 'Kein Eintrag';
                if(detailViewPersonWantedFlagEl) {
                    detailViewPersonWantedFlagEl.className = 'flag hidden';
                    if (person.wantedStatus === "Gesucht") { setVisibility(detailViewPersonWantedFlagEl, true, 'inline-block'); detailViewPersonWantedFlagEl.classList.add('wanted'); detailViewPersonWantedFlagEl.textContent = 'GESUCHT'; }
                    else if (person.wantedStatus === "Vorsicht") { setVisibility(detailViewPersonWantedFlagEl, true, 'inline-block'); detailViewPersonWantedFlagEl.classList.add('caution'); detailViewPersonWantedFlagEl.textContent = 'VORSICHT'; }
                }
                if(detailPersonFeaturesEl) detailPersonFeaturesEl.textContent = person.features || '-';
                if(detailPersonVehiclesListEl) {
                    detailPersonVehiclesListEl.innerHTML = '';
                    if (person.vehicles && person.vehicles.length > 0) {
                        person.vehicles.forEach(plate => {
                            const vehicle = mockVehicleDatabase.find(v => v.plate === plate);
                            const li = document.createElement('li');
                            li.textContent = vehicle ? `${plate} (${vehicle.make} ${vehicle.model}, ${vehicle.color})` : plate;
                            detailPersonVehiclesListEl.appendChild(li);
                        });
                    } else detailPersonVehiclesListEl.textContent = '-';
                }
                if(detailPersonLicensesEl) detailPersonLicensesEl.textContent = person.licenses || '-';
                if(detailPersonPriorsEl) {
                    detailPersonPriorsEl.innerHTML = '';
                    if (person.priors && person.priors.length > 0) person.priors.forEach(p => detailPersonPriorsEl.innerHTML += `<li>${p}</li>`);
                    else detailPersonPriorsEl.innerHTML = '<li>Keine Einträge</li>';
                }
                if(detailPersonNotesEl) detailPersonNotesEl.textContent = person.notes || 'Keine Notizen vorhanden.';
                setVisibility(personDetailViewEl, true, 'block');
            }

            if (personSearchBtnEl) {
                personSearchBtnEl.addEventListener('click', () => {
                    if (pcState !== 'desktop_active' || !personSearchNameInputEl || !personResultsAreaEl) return;
                    const searchTermName = personSearchNameInputEl.value.trim().toLowerCase();
                    const searchTermId = personSearchIdInputEl.value.trim().toLowerCase();
                    setVisibility(personDetailViewEl, false);
                    const results = mockPersonDatabase.filter(p =>
                        (searchTermName && `${p.firstName.toLowerCase()} ${p.lastName.toLowerCase()}`.includes(searchTermName)) ||
                        (searchTermId && p.citizenId.toLowerCase().includes(searchTermId))
                    );
                    if (results.length > 0) {
                        personResultsAreaEl.innerHTML = `<p class="text-green-600">${results.length} Treffer gefunden. Erster Treffer wird angezeigt.</p>`;
                        displayPersonDetails(results[0]);
                    } else personResultsAreaEl.innerHTML = '<p class="text-red-500">Keine Personen für Ihre Suche gefunden.</p>';
                });
            }
            if (createNewPersonBtnEl) {
                createNewPersonBtnEl.addEventListener('click', () => {
                    if (pcState === 'desktop_active' && createPersonModalEl && createPersonFormEl) {
                        createPersonFormEl.reset(); editingPersonCitizenIdFieldEl.value = "";
                        personModalCitizenIdEl.readOnly = false;
                        document.querySelector('#createPersonModalEl .modal-header h4').textContent = "Neue Personenakte erstellen";
                        setVisibility(createPersonModalEl, true);
                    }
                });
            }
            if (closeCreatePersonModalBtnEl) closeCreatePersonModalBtnEl.addEventListener('click', () => setVisibility(createPersonModalEl, false));
            if (cancelPersonBtnEl) cancelPersonBtnEl.addEventListener('click', () => setVisibility(createPersonModalEl, false));
            if (savePersonBtnEl && createPersonFormEl) {
                savePersonBtnEl.addEventListener('click', () => {
                    const personData = {
                        firstName: personModalFirstNameEl.value, lastName: personModalLastNameEl.value, dob: personModalDobEl.value,
                        citizenId: personModalCitizenIdEl.value, address: personModalAddressEl.value, phone: personModalPhoneEl.value,
                        occupation: personModalOccupationEl.value, profilePicUrl: personModalProfilePicUrlEl.value, features: personModalFeaturesEl.value,
                        licenses: personModalLicensesEl.value, wantedStatus: personModalWantedStatusEl.value, notes: personModalNotesEl.value,
                        priors: [], vehicles: []
                    };
                    if (!personData.firstName || !personData.lastName || !personData.citizenId) { alert("Vorname, Nachname und Bürger-ID sind Pflichtfelder!"); return; }
                    const existingIdToUpdate = editingPersonCitizenIdFieldEl.value;
                    if (existingIdToUpdate) {
                        const personIndex = mockPersonDatabase.findIndex(p => p.citizenId === existingIdToUpdate);
                        if (personIndex > -1) {
                            personData.priors = mockPersonDatabase[personIndex].priors; personData.vehicles = mockPersonDatabase[personIndex].vehicles;
                            mockPersonDatabase[personIndex] = personData; alert(`Akte für ${personData.firstName} ${personData.lastName} aktualisiert!`);
                            displayPersonDetails(personData);
                        }
                    } else {
                         if (mockPersonDatabase.some(p => p.citizenId === personData.citizenId)) { alert("Eine Person mit dieser Bürger-ID existiert bereits!"); return; }
                        mockPersonDatabase.push(personData); alert(`Akte für ${personData.firstName} ${personData.lastName} erstellt!`);
                        displayPersonDetails(personData);
                    }
                    setVisibility(createPersonModalEl, false);
                    if(personResultsAreaEl) personResultsAreaEl.innerHTML = `<p class="text-green-600">Akte erfolgreich verarbeitet. Details unten.</p>`;
                });
            }

            function populateVehicleModal(vehicle) {
                editingVehiclePlateFieldEl.value = vehicle.plate;
                vehicleModalPlateEl.value = vehicle.plate; vehicleModalPlateEl.readOnly = true;
                vehicleModalMakeEl.value = vehicle.make; vehicleModalModelEl.value = vehicle.model;
                vehicleModalColorEl.value = vehicle.color; vehicleModalOwnerCitizenIdEl.value = vehicle.ownerCitizenId;
                vehicleModalImageUrlEl.value = vehicle.imageUrl; vehicleModalWantedStatusEl.value = vehicle.wantedStatus;
                vehicleModalNotesEl.value = vehicle.notes;
                document.querySelector('#createVehicleModalEl .modal-header h4').textContent = "Fahrzeugakte bearbeiten";
                setVisibility(createVehicleModalEl, true);
            }

            if (editVehicleBtnEl) {
                editVehicleBtnEl.addEventListener('click', () => {
                    const plate = detailVehiclePlateEl.textContent;
                    const vehicleToEdit = mockVehicleDatabase.find(v => v.plate === plate);
                    if (vehicleToEdit) populateVehicleModal(vehicleToEdit);
                    else alert("Fehler: Fahrzeug zum Bearbeiten nicht gefunden.");
                });
            }

            function displayVehicleDetails(vehicle) {
                if (!vehicleDetailViewEl || !vehicle) { setVisibility(vehicleDetailViewEl, false); return; }
                if(detailVehicleImageEl) detailVehicleImageEl.src = vehicle.imageUrl || 'https://placehold.co/150x100/cccccc/ffffff?text=Fahrzeug';
                if(detailVehiclePlateEl) detailVehiclePlateEl.textContent = vehicle.plate;
                if(detailVehicleMakeEl) detailVehicleMakeEl.textContent = vehicle.make || '-';
                if(detailVehicleModelEl) detailVehicleModelEl.textContent = vehicle.model || '-';
                if(detailVehicleColorEl) detailVehicleColorEl.textContent = vehicle.color || '-';
                if(detailVehicleOwnerNameEl && detailVehicleOwnerIdEl) {
                    const owner = mockPersonDatabase.find(p => p.citizenId === vehicle.ownerCitizenId);
                    detailVehicleOwnerNameEl.textContent = owner ? `${owner.firstName} ${owner.lastName}` : (vehicle.ownerCitizenId ? 'Unbekannt' : '-');
                    detailVehicleOwnerIdEl.textContent = vehicle.ownerCitizenId || '-';
                }
                if(detailVehicleWantedStatusOutputEl) detailVehicleWantedStatusOutputEl.textContent = vehicle.wantedStatus || 'Kein Eintrag';
                if(detailVehicleWantedFlagEl) {
                    detailVehicleWantedFlagEl.className = 'flag hidden';
                    if (vehicle.wantedStatus === "Gestohlen" || vehicle.wantedStatus === "Zur Fahndung (Verbrechen)") {
                        setVisibility(detailVehicleWantedFlagEl, true, 'inline-block'); detailVehicleWantedFlagEl.classList.add('wanted');
                        detailVehicleWantedFlagEl.textContent = vehicle.wantedStatus.toUpperCase();
                    }
                }
                if(detailVehicleNotesEl) detailVehicleNotesEl.textContent = vehicle.notes || 'Keine Notizen vorhanden.';
                setVisibility(vehicleDetailViewEl, true, 'block');
            }

            if(vehicleSearchBtnEl) {
                vehicleSearchBtnEl.addEventListener('click', () => {
                    if (pcState !== 'desktop_active' || !vehicleSearchPlateInputEl || !vehicleResultsAreaEl) return;
                    const searchTermPlate = vehicleSearchPlateInputEl.value.trim().toUpperCase();
                    const searchTermOwnerId = vehicleSearchOwnerIdInputEl.value.trim();
                    setVisibility(vehicleDetailViewEl, false);
                    const results = mockVehicleDatabase.filter(v =>
                        (searchTermPlate && v.plate.toUpperCase().includes(searchTermPlate)) ||
                        (searchTermOwnerId && v.ownerCitizenId === searchTermOwnerId)
                    );
                    if (results.length > 0) {
                        vehicleResultsAreaEl.innerHTML = `<p class="text-green-600">${results.length} Fahrzeug(e) gefunden. Erster Treffer wird angezeigt.</p>`;
                        displayVehicleDetails(results[0]);
                    } else vehicleResultsAreaEl.innerHTML = '<p class="text-red-500">Keine Fahrzeuge für Ihre Suche gefunden.</p>';
                });
            }
            if(createNewVehicleBtnEl) {
                 createNewVehicleBtnEl.addEventListener('click', () => {
                    if (pcState === 'desktop_active' && createVehicleModalEl && createVehicleFormEl) {
                        createVehicleFormEl.reset(); editingVehiclePlateFieldEl.value = "";
                        vehicleModalPlateEl.readOnly = false;
                        document.querySelector('#createVehicleModalEl .modal-header h4').textContent = "Neues Fahrzeug erfassen";
                        setVisibility(createVehicleModalEl, true);
                    }
                });
            }
            if(closeCreateVehicleModalBtnEl) closeCreateVehicleModalBtnEl.addEventListener('click', () => setVisibility(createVehicleModalEl, false));
            if(cancelVehicleBtnEl) cancelVehicleBtnEl.addEventListener('click', () => setVisibility(createVehicleModalEl, false));
            if(saveVehicleBtnEl && createVehicleFormEl) {
                saveVehicleBtnEl.addEventListener('click', () => {
                    const vehicleData = {
                        plate: vehicleModalPlateEl.value.toUpperCase(), make: vehicleModalMakeEl.value, model: vehicleModalModelEl.value,
                        color: vehicleModalColorEl.value, ownerCitizenId: vehicleModalOwnerCitizenIdEl.value, imageUrl: vehicleModalImageUrlEl.value,
                        wantedStatus: vehicleModalWantedStatusEl.value, notes: vehicleModalNotesEl.value
                    };
                    if (!vehicleData.plate) { alert("Kennzeichen ist ein Pflichtfeld!"); return; }
                    const existingPlateToUpdate = editingVehiclePlateFieldEl.value;
                    if (existingPlateToUpdate) {
                        const vehicleIndex = mockVehicleDatabase.findIndex(v => v.plate === existingPlateToUpdate);
                        if (vehicleIndex > -1) {
                            const oldOwnerId = mockVehicleDatabase[vehicleIndex].ownerCitizenId;
                            if (oldOwnerId && oldOwnerId !== vehicleData.ownerCitizenId) {
                                const oldOwner = mockPersonDatabase.find(p => p.citizenId === oldOwnerId);
                                if (oldOwner && oldOwner.vehicles) oldOwner.vehicles = oldOwner.vehicles.filter(vPlate => vPlate !== existingPlateToUpdate);
                            }
                            mockVehicleDatabase[vehicleIndex] = vehicleData; alert(`Fahrzeug ${vehicleData.plate} aktualisiert!`);
                        }
                    } else {
                        if (mockVehicleDatabase.some(v => v.plate === vehicleData.plate)) { alert("Ein Fahrzeug mit diesem Kennzeichen existiert bereits!"); return; }
                        mockVehicleDatabase.push(vehicleData); alert(`Fahrzeug ${vehicleData.plate} erstellt!`);
                    }
                    if (vehicleData.ownerCitizenId) {
                        const owner = mockPersonDatabase.find(p => p.citizenId === vehicleData.ownerCitizenId);
                        if (owner) {
                            if (!owner.vehicles) owner.vehicles = [];
                            if (!owner.vehicles.includes(vehicleData.plate)) owner.vehicles.push(vehicleData.plate);
                        } else alert("Warnung: Angegebene Halter Bürger-ID nicht gefunden.");
                    }
                    setVisibility(createVehicleModalEl, false); displayVehicleDetails(vehicleData);
                    if(vehicleResultsAreaEl) vehicleResultsAreaEl.innerHTML = `<p class="text-green-600">Fahrzeug ${vehicleData.plate} verarbeitet.</p>`;
                });
            }

            function renderActiveUnits() {
                if (!activeUnitsListEl || !assignUnitToIncidentSelectEl) return;
                activeUnitsListEl.innerHTML = ''; assignUnitToIncidentSelectEl.innerHTML = '<option value="">Einheit auswählen...</option>';
                if (mockUnitsOnDuty.length === 0) { activeUnitsListEl.innerHTML = '<p class="text-sm text-gray-500">Keine Einheiten im Dienst.</p>'; return; }
                const ul = document.createElement('ul'); ul.className = 'space-y-2';
                mockUnitsOnDuty.forEach(unit => {
                    const li = document.createElement('li'); li.className = 'text-sm p-2 border rounded-md flex justify-between items-center';
                    let statusClass = 'status-offduty';
                    if (unit.status === 'Verfügbar') statusClass = 'status-available';
                    else if (unit.status === 'Im Einsatz') statusClass = 'status-busy';
                    else if (unit.status === 'Pause') statusClass = 'status-unavailable';
                    li.innerHTML = `<div><span class="status-dot ${statusClass}"></span> <strong>${unit.unitId}</strong> (${unit.officer})</div> <span>${unit.status}</span>`;
                    ul.appendChild(li);
                    if (unit.status === 'Verfügbar') {
                        const option = document.createElement('option'); option.value = unit.unitId;
                        option.textContent = `${unit.unitId} (${unit.officer})`; assignUnitToIncidentSelectEl.appendChild(option);
                    }
                });
                activeUnitsListEl.appendChild(ul);
            }

            function renderActiveIncidents() {
                if (!activeIncidentsTableBodyEl) return;
                activeIncidentsTableBodyEl.innerHTML = '';
                if (mockIncidentsDatabase.length === 0) { activeIncidentsTableBodyEl.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Keine aktiven Einsätze.</td></tr>'; return; }
                mockIncidentsDatabase.forEach(incident => {
                    const row = activeIncidentsTableBodyEl.insertRow();
                    row.insertCell().textContent = incident.incidentId; row.insertCell().textContent = incident.type;
                    row.insertCell().textContent = incident.priority; row.insertCell().textContent = incident.location;
                    row.insertCell().textContent = incident.status; row.insertCell().textContent = incident.assignedUnits.join(', ') || '-';
                    const actionsCell = row.insertCell(); actionsCell.className = 'action-buttons';
                    const detailsBtn = document.createElement('button'); detailsBtn.innerHTML = '<i class="fas fa-eye"></i> Details';
                    detailsBtn.onclick = () => displayIncidentDetails(incident.incidentId); actionsCell.appendChild(detailsBtn);
                });
                 renderDashboardLists();
            }
            let currentOpenIncidentId = null;
            function displayIncidentDetails(incidentId) {
                const incident = mockIncidentsDatabase.find(inc => inc.incidentId === incidentId);
                if (!incident || !incidentDetailViewEl) { setVisibility(incidentDetailViewEl, false); currentOpenIncidentId = null; return; }
                currentOpenIncidentId = incident.incidentId;
                detailIncidentIdEl.textContent = incident.incidentId; detailIncidentTypeEl.textContent = incident.type;
                detailIncidentLocationEl.textContent = incident.location; detailIncidentPriorityEl.textContent = incident.priority;
                detailIncidentStatusEl.textContent = incident.status; detailIncidentDescriptionEl.textContent = incident.description;
                detailIncidentUnitsEl.textContent = incident.assignedUnits.join(', ') || 'Keine';
                setVisibility(incidentDetailViewEl, true, 'block'); renderAvailableUnitsForAssignment();
            }
             function renderAvailableUnitsForAssignment() {
                if (!assignUnitToIncidentSelectEl) return;
                assignUnitToIncidentSelectEl.innerHTML = '<option value="">Einheit auswählen...</option>';
                mockUnitsOnDuty.filter(u => u.status === 'Verfügbar').forEach(unit => {
                    const option = document.createElement('option'); option.value = unit.unitId;
                    option.textContent = `${unit.unitId} (${unit.officer})`; assignUnitToIncidentSelectEl.appendChild(option);
                });
            }

            if (updateUnitStatusBtnEl) {
                updateUnitStatusBtnEl.addEventListener('click', () => {
                    const unitId = unitIdInputEl.value.trim();
                    const status = unitStatusSelectEl.value;

                    if (!unitId && status !== "Nicht im Dienst" && !currentActiveUnitId) {
                        alert("Bitte Einheit-ID eingeben, um sich anzumelden.");
                        return;
                    }

                    if (currentActiveUnitId && ( (unitId && unitId !== currentActiveUnitId) || status === "Nicht im Dienst") ) {
                        const myUnitIndex = mockUnitsOnDuty.findIndex(u => u.unitId === currentActiveUnitId && u.officer === currentLoggedInUser);
                        if (myUnitIndex > -1) {
                            mockUnitsOnDuty.splice(myUnitIndex, 1);
                        }
                        currentActiveUnitId = null;
                        unitIdInputEl.value = "";
                        unitIdInputEl.disabled = false;
                        updateUnitStatusBtnEl.textContent = "Status aktualisieren / Anmelden";
                    }

                    if (status === "Nicht im Dienst") {
                        if (!currentActiveUnitId && unitId) {
                             const otherUnitIndex = mockUnitsOnDuty.findIndex(u => u.unitId === unitId);
                             if(otherUnitIndex > -1 && mockUnitsOnDuty[otherUnitIndex].officer !== currentLoggedInUser){
                                 alert("Diese Einheit ist von einem anderen Officer registriert.");
                             } else if (otherUnitIndex > -1) {
                                 mockUnitsOnDuty.splice(otherUnitIndex, 1);
                             }
                        }
                        unitIdInputEl.value = "";
                        unitIdInputEl.disabled = false;
                        updateUnitStatusBtnEl.textContent = "Status aktualisieren / Anmelden";
                        renderActiveUnits();
                        renderUnitStatusDashboard();
                        return;
                    }

                    const targetUnitId = currentActiveUnitId || unitId;
                    if (!targetUnitId) {
                        alert("Fehler: Keine Einheit-ID zum Aktualisieren.");
                        return;
                    }

                    if (!currentActiveUnitId && mockUnitsOnDuty.some(u => u.unitId === targetUnitId && u.officer !== currentLoggedInUser)) {
                        alert(`Einheit-ID ${targetUnitId} ist bereits von einem anderen Officer belegt.`);
                        return;
                    }

                    const existingUnitIndex = mockUnitsOnDuty.findIndex(u => u.unitId === targetUnitId);
                    if (existingUnitIndex > -1) {
                        if (mockUnitsOnDuty[existingUnitIndex].officer === currentLoggedInUser) {
                             mockUnitsOnDuty[existingUnitIndex].status = status;
                        } else {
                            alert(`Einheit-ID ${targetUnitId} ist bereits von einem anderen Officer belegt.`);
                            return;
                        }
                    } else {
                        mockUnitsOnDuty.push({ unitId: targetUnitId, officer: currentLoggedInUser, status });
                    }

                    currentActiveUnitId = targetUnitId;
                    unitIdInputEl.value = currentActiveUnitId;
                    unitIdInputEl.disabled = true;
                    updateUnitStatusBtnEl.textContent = "Status aktualisieren";


                    renderActiveUnits();
                    renderUnitStatusDashboard();
                });
            }


            if (createNewIncidentBtnEl) { createNewIncidentBtnEl.addEventListener('click', () => { createIncidentFormEl.reset(); document.querySelector('#createIncidentModalEl .modal-header h4').textContent = "Neuen Einsatz erstellen"; setVisibility(createIncidentModalEl, true); }); }
            if(closeCreateIncidentModalBtnEl) closeCreateIncidentModalBtnEl.addEventListener('click', () => setVisibility(createIncidentModalEl, false));
            if(cancelIncidentBtnEl) cancelIncidentBtnEl.addEventListener('click', () => setVisibility(createIncidentModalEl, false));
            if (saveIncidentBtnEl) {
                saveIncidentBtnEl.addEventListener('click', () => {
                    const incidentData = {
                        incidentId: generateUniqueId("E"), type: incidentModalTypeEl.value, priority: incidentModalPriorityEl.value,
                        location: incidentModalLocationEl.value, callerName: incidentModalCallerNameEl.value, callerPhone: incidentModalCallerPhoneEl.value,
                        description: incidentModalDescriptionEl.value, status: "Offen", assignedUnits: [], timestamp: new Date().toLocaleString('de-DE')
                    };
                    if (!incidentData.location || !incidentData.description) { alert("Ort und Beschreibung sind Pflichtfelder!"); return; }
                    mockIncidentsDatabase.push(incidentData); alert(`Einsatz #${incidentData.incidentId} erstellt!`);
                    setVisibility(createIncidentModalEl, false); renderActiveIncidents();
                });
            }

            if (assignUnitBtnEl && assignUnitToIncidentSelectEl) {
                assignUnitBtnEl.addEventListener('click', () => {
                    if (!currentOpenIncidentId) { alert("Kein Einsatz ausgewählt."); return; }
                    const unitIdToAssign = assignUnitToIncidentSelectEl.value;
                    if (!unitIdToAssign) { alert("Bitte eine Einheit auswählen."); return; }
                    const incident = mockIncidentsDatabase.find(inc => inc.incidentId === currentOpenIncidentId);
                    const unit = mockUnitsOnDuty.find(u => u.unitId === unitIdToAssign);
                    if (incident && unit && unit.status === 'Verfügbar') {
                        if (!incident.assignedUnits.includes(unitIdToAssign)) {
                            incident.assignedUnits.push(unitIdToAssign); incident.status = "Zugewiesen"; unit.status = "Im Einsatz";
                            alert(`${unitIdToAssign} wurde Einsatz #${incident.incidentId} zugewiesen.`);
                            displayIncidentDetails(incident.incidentId); renderActiveIncidents(); renderActiveUnits(); renderUnitStatusDashboard(); renderAvailableUnitsForAssignment();
                        } else alert(`${unitIdToAssign} ist diesem Einsatz bereits zugewiesen.`);
                    } else alert("Fehler bei der Zuweisung. Einsatz oder Einheit nicht gefunden/verfügbar.");
                });
            }

            if (createReportFromIncidentBtnEl) {
                createReportFromIncidentBtnEl.addEventListener('click', () => {
                    if (!currentOpenIncidentId) { alert("Kein Einsatz für Berichterstellung ausgewählt."); return; }
                    const incident = mockIncidentsDatabase.find(inc => inc.incidentId === currentOpenIncidentId);
                    if (incident && createReportModalEl && createReportFormEl) {
                        createReportFormEl.reset(); reportModalIncidentIdInputEl.value = incident.incidentId;
                        reportModalLocationEl.value = incident.location; reportModalTitleEl.value = `Bericht zu Einsatz #${incident.incidentId} - ${incident.type}`;
                        document.querySelector('#createReportModalEl .modal-header h4').textContent = "Bericht erstellen";
                        setVisibility(createReportModalEl, true); switchCadContent('reportsContent');
                    }
                });
            }

            function renderReportsList() {
                if (!reportsListAreaTableBodyEl) return;
                reportsListAreaTableBodyEl.innerHTML = '';
                if (mockReportsDatabase.length === 0) { reportsListAreaTableBodyEl.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">Keine Berichte vorhanden.</td></tr>'; return; }
                mockReportsDatabase.forEach(report => {
                    const row = reportsListAreaTableBodyEl.insertRow();
                    row.insertCell().textContent = report.reportId; row.insertCell().textContent = report.incidentId || '-';
                    row.insertCell().textContent = report.title; row.insertCell().textContent = report.timestamp;
                    row.insertCell().textContent = report.officer;
                    const actionsCell = row.insertCell(); actionsCell.className = 'action-buttons';
                    const viewBtn = document.createElement('button'); viewBtn.innerHTML = '<i class="fas fa-eye"></i> Ansehen';
                    viewBtn.onclick = () => displayReportDetails(report.reportId); actionsCell.appendChild(viewBtn);
                });
                renderDashboardLists();
            }

            function displayReportDetails(reportId) {
                const report = mockReportsDatabase.find(r => r.reportId === reportId);
                if (!report || !reportDetailViewEl) { setVisibility(reportDetailViewEl, false); return; }
                detailReportIdEl.textContent = report.reportId; detailReportIncidentIdEl.textContent = report.incidentId || 'N/A';
                detailReportTimestampEl.textContent = report.timestamp; detailReportOfficerEl.textContent = report.officer;
                detailReportLocationEl.textContent = report.location; detailReportTitleEl.textContent = report.title;
                detailReportNarrativeEl.textContent = report.narrative; detailReportActionsEl.textContent = report.actionsTaken || '-';
                detailReportPersonsEl.innerHTML = report.personsInvolved && report.personsInvolved.length > 0 ? report.personsInvolved.map(p => `<li>${p}</li>`).join('') : '<li>Keine</li>';
                detailReportVehiclesEl.innerHTML = report.vehiclesInvolved && report.vehiclesInvolved.length > 0 ? report.vehiclesInvolved.map(v => `<li>${v}</li>`).join('') : '<li>Keine</li>';
                setVisibility(reportDetailViewEl, true, 'block');
            }

            if(closeCreateReportModalBtnEl) closeCreateReportModalBtnEl.addEventListener('click', () => setVisibility(createReportModalEl, false));
            if(cancelReportBtnEl) cancelReportBtnEl.addEventListener('click', () => setVisibility(createReportModalEl, false));
            if(saveReportBtnEl) {
                saveReportBtnEl.addEventListener('click', () => {
                    const reportData = {
                        reportId: generateUniqueId("R"), incidentId: reportModalIncidentIdInputEl.value, title: reportModalTitleEl.value,
                        location: reportModalLocationEl.value, narrative: reportModalNarrativeEl.value,
                        personsInvolved: reportModalPersonsInvolvedEl.value.split('\n').filter(p => p.trim() !== ""),
                        vehiclesInvolved: reportModalVehiclesInvolvedEl.value.split('\n').filter(v => v.trim() !== ""),
                        actionsTaken: reportModalActionsTakenEl.value, officer: currentLoggedInUser, timestamp: new Date().toLocaleString('de-DE')
                    };
                    if (!reportData.title || !reportData.narrative) { alert("Titel und Sachverhalt sind Pflichtfelder!"); return; }
                    mockReportsDatabase.push(reportData); alert(`Bericht #${reportData.reportId} gespeichert!`);
                    setVisibility(createReportModalEl, false); renderReportsList();
                });
            }
            function renderDashboardLists() {
                if (dashboardActiveIncidentsListEl) {
                    dashboardActiveIncidentsListEl.innerHTML = '';
                    const activeIncidents = mockIncidentsDatabase.filter(inc => inc.status !== "Abgeschlossen").slice(0, 3);
                    if (activeIncidents.length === 0) dashboardActiveIncidentsListEl.innerHTML = '<li>Keine aktiven Einsätze</li>';
                    else activeIncidents.forEach(inc => { const li = document.createElement('li'); li.textContent = `#${inc.incidentId}: ${inc.type} - ${inc.location}`; dashboardActiveIncidentsListEl.appendChild(li); });
                }
                if (dashboardMyReportsListEl) {
                    dashboardMyReportsListEl.innerHTML = '';
                    const myReports = mockReportsDatabase.filter(rep => rep.officer === currentLoggedInUser).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0,2);
                    if (myReports.length === 0) dashboardMyReportsListEl.innerHTML = '<li>Keine Berichte von Ihnen</li>';
                    else myReports.forEach(rep => { const li = document.createElement('li'); li.textContent = `#${rep.reportId}: ${rep.title}`; dashboardMyReportsListEl.appendChild(li); });
                }
            }

            function renderUnitStatusDashboard() {
                if (!unitStatusListDashboardEl) return;
                unitStatusListDashboardEl.innerHTML = '';
                if (mockUnitsOnDuty.length === 0) { unitStatusListDashboardEl.innerHTML = '<li>Keine Einheiten im Dienst</li>'; return; }
                mockUnitsOnDuty.forEach(unit => {
                    const li = document.createElement('li'); let statusClass = 'status-offduty';
                    if (unit.status === 'Verfügbar') statusClass = 'status-available';
                    else if (unit.status === 'Im Einsatz') statusClass = 'status-busy';
                    else if (unit.status === 'Pause') statusClass = 'status-unavailable';
                    li.innerHTML = `<span class="status-dot ${statusClass}"></span> ${unit.unitId} (${unit.officer}) - ${unit.status}`;
                    unitStatusListDashboardEl.appendChild(li);
                });
            }

            let isResizing = false;
            if (resizerEl && cadWindowEl) {
                resizerEl.addEventListener('mousedown', (e) => {
                    if (pcState !== 'desktop_active' || e.button !== 0 || cadWindowEl.classList.contains('maximized')) return;
                    isResizing = true; const startX = e.clientX, startY = e.clientY;
                    const startWidth = parseInt(window.getComputedStyle(cadWindowEl).width, 10);
                    const startHeight = parseInt(window.getComputedStyle(cadWindowEl).height, 10);
                    document.onmousemove = function(ev) {
                        if (!isResizing) return;
                        const newWidth = startWidth + ev.clientX - startX, newHeight = startHeight + ev.clientY - startY;
                        cadWindowEl.style.width = Math.max(parseInt(cadWindowEl.style.minWidth) || 400, newWidth) + 'px';
                        cadWindowEl.style.height = Math.max(parseInt(cadWindowEl.style.minHeight) || 300, newHeight) + 'px';
                    }
                    document.onmouseup = function() { isResizing = false; document.onmousemove = null; document.onmouseup = null; }
                    e.preventDefault();
                });
            }

            function updateTime() {
                if (currentTimeEl) {
                    const now = new Date(), options = { weekday: 'short', hour: '2-digit', minute: '2-digit' };
                    try { currentTimeEl.textContent = now.toLocaleTimeString('de-DE', options).replace(' Uhr', ''); }
                    catch (e) { currentTimeEl.textContent = now.toLocaleTimeString(undefined, options).replace(' Uhr', '');}
                }
            }
            updateTime(); setInterval(updateTime, 30000);

            showPowerButtonScreen(); // Start with power button screen
        });
    </script>
</body>
</html>
